```{r}
library(tidyverse)
library(sf)
library(tmap)
library(here)
library(osmdata)

source(here("scripts", "get_acs_data.R"))
source(here("scripts", "plot_utility_functions.R"))
source(here("scripts", "plot_comparison_charts.R"))
source(here("scripts", "plot_boulevard_map.R"))
source(here("scripts", "plot_acs_maps.R"))
source(here("scripts", "get_non_acs_data.R"))

# Set working directory and file paths
username <- getwd() %>% str_split("\\/") %>% unlist() %>% .[3]
file_path <- file.path("C:", "Users", username, "Box", "LA Transit project", "Social Climate Analysis")

options(
  tigris_use_cache = TRUE,
  scipen = 999999)
```

Set a boulevard variable

```{r}
boulevard = "hoover"
boulevard_tracts = file.path(file_path, boulevard, "maps", str_c(boulevard, "_buffer_tracts.shp")) %>%
  st_read(quiet = TRUE) %>% 
  st_set_crs(4326)
```

Obtaining ACS data
```{r}
acs_tracts_la = get_acs_data(
    file_path = file_path, 
    area = "LA",
    census_geography = "tract")

acs_tracts_boulevard = acs_tracts_la %>%
  filter(GEOID %in% boulevard_tracts$GEOID)

acs_city_la = get_acs_data(
  file_path = file_path, 
  area = "LA", 
  census_geography = "place") 
```

Plotting comparison charts 
```{r, fig.width = 6.5, fig.height = 2.5}
color_palette = c(
  "LA City" = "#00447c",
  "Hoover" = "#A7c539")

plot_metadata = tribble(
  ~constructs, ~denominators,
  "income", "B19001_001",
  "employment", "B23001_001",
  "age", "B01001_001",
  "ethnicity", "B03002_001",
  "family", "B11003_001",
  "english", "B16004_001",
  "language", "english_less_than_very_well_denominator",
  "device", "B28001_001",
  "commute_mode", "B08301_001",
  "commute_time", "B08303_001",
  "tenure", "B25003_001",
  "rent_burden", "rent_burden_denominator",
  "school", "B14007_001"
  )

comparison_charts = plot_comparison_charts(
  df_boulevard = acs_tracts_boulevard, 
  df_city = acs_city_la,
  boulevard_name = "Hoover",
  color = color_palette,
  constructs = plot_metadata$constructs,
  denominators = plot_metadata$denominators,
  save = FALSE,
  outpath = file.path(file_path, boulevard, "Outputs"),
  file_extension = ".png")

comparison_charts
```


Prepare spatial layers
```{r}
projection = 2229

## tracts
la_tracts <- st_read(file.path(file_path, "Hoover/maps/CA_census_Tracts.shp")) %>% 
  filter(COUNTYFP == "037") #%>%
  #st_transform(projection)

# boulevard_tracts <- st_read(file.path(file_path, "Pico/Maps/pico_buffer_tracts.shp")) %>%
#   st_transform(4326) %>%
#   st_make_valid()

boulevard_tracts <- la_tracts %>%
  filter(GEOID %in% boulevard_tracts$GEOID)

## will need to update this 
streets_sf = tribble(
  ~name, ~lat, ~lon, ~orientation, ~boulevard,
  
  #### Pico Locations ####
  # "Wilshire Blvd", 34.06217056027787, -118.29424612980146, 0, boulevard,
  # "Olympic Blvd", 34.05754326508076, -118.34502694326508, 0, boulevard,
  # "Washington Blvd", 34.040903520026625, -118.34737421737195, -10, boulevard,
  # "Rosa Parks Fwy", 34.036465982980886, -118.29767182226023, 0, boulevard,
  # "Adams Blvd", 34.03283003396823, -118.3254615038501, 0, boulevard,
  # "Jefferson Blvd", 34.02516133685176, -118.314070166191, 0, boulevard,
  # # "La Brea Ave", 34.037457517681425, -118.34948870419119, 75, boulevard,
  # "Crenshaw Blvd", 34.059019617009476, -118.32025318579531, 67, boulevard,
  # "Arlington Ave", 34.03130279886178, -118.31775449166764, 90, boulevard,
  # "Western Ave", 34.03064831048125, -118.30907566457537, 90, boulevard,
  # "Normandie Ave", 34.03040186970061, -118.30027509279961, 90, boulevard,
  # "Vermont Ave", 34.031803023478986, -118.29147407689182, 90, boulevard,
  # "Hoover St", 34.03191105597345, -118.28495893090334, 90, boulevard,
  # "Harbor Fwy", 34.05418379708543, -118.25980368140354, 55, boulevard
  
  #### Hoover Locations ####
  "MLK Jr Blvd", 34.01114719258918, -118.26536648634915, 0, boulevard,
  "Vernon Ave", 34.003854692348405, -118.26536648634915, 0, boulevard,
  "Slauson Ave", 33.98932307117704, -118.26523319659992, 0, boulevard,
  "Florence Ave", 33.974733696872036, -118.25616655173909, 0, boulevard,
  "Manchester Ave", 33.960118221849065, -118.25607145690896, 0, boulevard,
  "Harbor Fwy", 33.982781626478186, -118.28060176708684, 270, boulevard,
  "Vermont Ave", 33.98235972870656, -118.29168835018301, 90, boulevard,
  "Normandie Ave", 33.98235972870656, -118.30030677623152, 90, boulevard,
  "Van Ness Ave", 33.983371941772745, -118.317750099191, 90, boulevard,
  "Crenshaw Blvd", 33.98297019442496, -118.33092846920148, 90, boulevard,
  "Main St", 33.982436755767004, -118.27400241679408, 270, boulevard,
  "Avalon Blvd", 33.98253230870111, -118.26521583140891, 270, boulevard,
  "Exposition Blvd", 34.018306424628975, -118.30579458465892, 0, boulevard
  

  
  ) %>%
  st_as_sf(
    coords = c("lon", "lat"),
    crs = 4326) %>%
  #st_transform(projection) %>%
  filter(boulevard == !!boulevard)

#key locations
locations_sf = tribble(
  ~name, ~lat, ~lon, ~boulevard,
  
  #### Pico Locations ####
  # "Harold A Henry Park", 34.05771, -118.326204, boulevard,
  # "MacArthur Park", 34.059539, -118.277825, boulevard,
  # #"Los Angeles Elementary School", 34.04767415795226, -118.30564277817867, boulevard,
  # #"Los Angeles High School", 34.05631575779619, -118.33290205238154,  boulevard,
  # "Normandie Recreation Center", 34.044543, -118.299765, boulevard
  
  #### Hoover Locations ####
  "Exposition Park", 34.01465919961802, -118.28749014509255, boulevard,
  "Harvard Park", 33.984241239976996, -118.30467543777576, boulevard,
  "Algin Sutton Recreation Center", 33.95628624786266, -118.28592530502922, boulevard,
  "Augustus Hawkins High School", 33.98689352636203, -118.28809332457882, boulevard,
  "Vermont Square Park", 34.00025327505379, -118.2972922149193, boulevard,
  "South Park Recreation Center", 33.997457650265595, -118.26774886549762, boulevard

  ) %>%
  st_as_sf(coords = c("lon", "lat"), crs = 4326) #%>%
  #st_transform(projection)

boulevard_outline <- st_union(boulevard_tracts) #%>%
  #st_transform(projection)
boulevard_corridor <- st_read(file.path(file_path, boulevard, "maps", paste0(boulevard, "_blvd.shp"))) %>%
  st_transform(4326) 
```


Plot chloropleths
```{r, fig.width = 6.5, fig.height = 4.5}
# "share_hearing_diff", "Disability, Hearing",
# "share_vision_diff", "Disability, Vision",
# "share_ambulatory_diff", "Disability, Ambulatory",

## create plot metadata as a tribble with `fill_column` and `legend_title
plot_metadata = tribble(
  ~fill_column, ~legend_title,
  "population_density_sqmi", "Population Density\n(sq. mi)",
  "share_disability", "With a Disability",
  "B19013_001", "Median Income",
  "share_below_poverty", "Below Poverty Level",
  "share_no_internet", "No Internet Access",
  "share_no_computer", "No Computer Access",
  "share_renter_occupied", "Renter-Occupied",
  "share_no_car", "No Vehicle Access",
  "share_commute_hour_plus", "Commute Time (1 hour+)",
  "share_speak_korean_at_home", "Speak Korean at Home",
  "share_speak_spanish_at_home", "Speak Spanish at Home",
  "share_renter_housing_costburden_30plus", "Housing Cost Burden (30%+)",
  "share_renter_housing_costburden_50plus", "Housing Cost Burden (50%+)",
  "B25071_001", "Housing as Share of Income, Median"
)

plot_acs_maps(
  sf = acs_tracts_boulevard,
  boulevard_sf = boulevard_corridor,
  locations_sf = locations_sf,
  study_area_outline_sf = boulevard_outline,
  streets_sf = streets_sf,
  fill_column = plot_metadata$fill_column,
  legend_title = plot_metadata$legend_title,
  xpad = 5000,
  ypad = 0,
  height = 7,
  width = 6,
  save = TRUE,
  outpath = file.path(file_path, boulevard, "Outputs"),
  file_extension = ".png")
```

Non-ACS data
```{r}
affordable_housing_sf = get_non_acs_data(
  base_path = file_path,
  dataset_name = "affordable_housing",
  area = boulevard) %>%
  st_transform(projection)

senior_housing_sf = get_non_acs_data(
  base_path = file_path,
  dataset_name = "senior_housing",
  area = boulevard)

zoning_sf = get_non_acs_data(
  base_path = file_path,
  dataset_name = "zoning",
  area = boulevard) %>%
  st_intersection(boulevard_corridor %>% st_buffer(2640))

h_and_t_sf = boulevard_tracts %>%
  left_join(
    get_non_acs_data(
      base_path = file_path,
      dataset_name = "h_and_t",
      area = boulevard))

crash_sf = get_non_acs_data(
  base_path = file_path,
  dataset_name = "crash",
  area = boulevard)

hla_sf = get_non_acs_data(
  base_path = file_path,
  dataset_name = "hla",
  area = boulevard)
```

Non-ACS maps
```{r, fig.width = 6.5, fig.height = 4.5}
## affordable housing
plot_boulevard_map(
  tracts_sf = boulevard_tracts,
  sf = affordable_housing_sf,
  boulevard_sf = boulevard_corridor,
  fill_column = "#00447C",
  locations_sf = locations_sf,
  study_area_outline_sf = boulevard_outline,
  streets_sf = streets_sf,
  xpad = 5000,
  ypad = 0,
  height = 7,
  width = 6,
  projection = projection,
  legend_title = "Affordable Housing",
  style = "cont",
  map_type = "point",
  save = TRUE,
  file_extension = ".png",
  outpath = file.path(file_path, boulevard, "Outputs"))

## senior housing
plot_boulevard_map(
  tracts_sf = boulevard_tracts,
  sf = senior_housing_sf,
  boulevard_sf = boulevard_corridor,
  fill_column = "#00447C",
  locations_sf = locations_sf,
  study_area_outline_sf = boulevard_outline,
  streets_sf = streets_sf,
  xpad = 5000,
  ypad = 0,
  height = 7,
  width = 6,
  projection = projection,
  legend_title = "Senior Housing",
  style = "cont",
  map_type = "point",
  save = TRUE,
  file_extension = ".png",
  outpath = file.path(file_path, boulevard, "Outputs"))

## zoning
plot_boulevard_map(
  tracts_sf = boulevard_tracts,
  sf = zoning_sf,
  boulevard_sf = boulevard_corridor,
  fill_column = "zoning_category",
  locations_sf = locations_sf,
  study_area_outline_sf = boulevard_outline,
  streets_sf = streets_sf,
  xpad = 5000,
  ypad = 0,
  height = 7,
  width = 6,
  projection = projection,
  legend_title = "Zoning",
  palette_colors = c(
    "Agricultural or Open Space" = "#00447C",
    "Highways or Parking" = "#A7C539",
    "Commercial or Industrial" = "#F2B705",
    "Multi-family Residential" = "#780032",
    "Single-family Residential" = "#e66a8c",
    "Public" = "#D9D9D9"),
  style = "cat",
  map_type = "choropleth",
  border_color = NA,
  save = TRUE,
  file_extension = ".png",
  outpath = file.path(file_path, boulevard, "Outputs"))

## crashes
plot_boulevard_map(
  tracts_sf = boulevard_tracts,
  sf = crash_sf,
  boulevard_sf = boulevard_corridor,
  fill_column = "crash_type",
  locations_sf = locations_sf,
  study_area_outline_sf = boulevard_outline,
  streets_sf = streets_sf,
  xpad = 5000,
  ypad = 0,
  height = 7,
  width = 6,
  projection = projection,
  legend_title = "Crashes",
  palette_colors = c("Bicyclist invovled crash" = "#A7C539", 
                     "Pedestrian involved crash" = "#00447C", 
                     "Other vehicle crash" = "#780032"),
  map_type = "point",
  border_color = NA,
  save = TRUE,
  file_extension = ".png",
  outpath = file.path(file_path, boulevard, "Outputs"))

## hla (mobility improvements vote measure)
plot_boulevard_map(
  sf = hla_sf,
  boulevard_sf = boulevard_corridor,
  fill_column = "hla_affirmative_vote_share",
  locations_sf = locations_sf,
  study_area_outline_sf = boulevard_outline,
  streets_sf = streets_sf,
  xpad = 5000,
  ypad = 0,
  height = 7,
  width = 6,
  projection = projection,
  legend_title = "HLA Supporting",
  bins = 2,
  map_type = "choropleth",
  border_color = NA,
  style = "cont",
  save = TRUE,
  file_extension = ".png",
  outpath = file.path(file_path, boulevard, "Outputs"))

 

## housing and transportation affordability index (h+t)
## (but actually we're just plotting transportation costs)
plot_boulevard_map(
  sf = h_and_t_sf %>% mutate(t_ami = t_ami / 100),
  boulevard_sf = boulevard_corridor,
  fill_column = "t_ami",
  locations_sf = locations_sf,
  study_area_outline_sf = boulevard_outline,
  streets_sf = streets_sf,
  xpad = 5000,
  ypad = 0,
  height = 7,
  width = 6,
  projection = projection,
  legend_title = "Transportation as Share of Income",
  map_type = "choropleth",
  border_color = NA,
  style = "cont",
  save = TRUE,
  file_extension = ".png",
  outpath = file.path(file_path, boulevard, "Outputs"))
```

Table 1: Top Countries for Foreign-born Study Area Residents
```{r}
acs_tracts_boulevard %>%
  st_drop_geometry %>%
  ## table on foreign-born persons by country
  select(GEOID, matches("B05006_")) %>%
  pivot_longer(-GEOID, names_to = "variable", values_to = "estimate") %>% 
  mutate(
    country = case_when(
      variable == "B05006_001" ~ "Table universe",
      variable == "B05006_158" ~ "Guatemala",
      variable == "B05006_157" ~ "El Salvador",
      variable == "B05006_160" ~ "Mexico",
      variable == "B05006_054" ~ "Korea",
      variable == "B05006_049" ~ "China",
      variable == "B05006_074" ~ "Phillipines",
      variable == "B05006_159" ~ "Honduras",
      TRUE ~ NA_character_)) %>%
  summarize(
    .by = country, 
    estimate = sum(estimate, na.rm = TRUE)) %>%
  filter(!is.na(country), estimate > 1000) %>%
  arrange(desc(estimate)) %>%
  mutate(share = round((estimate / estimate[country == "Table universe"]) * 100, digits = 0))
```




```{r disability counts}

disability_counts <- acs_tracts_boulevard |>
  st_drop_geometry() |>
  select(B18101_004, B18101_007, B18101_010, B18101_013, B18101_016, B18101_019, B18101_023, B18101_026, B18101_029, B18101_032, B18101_035, B18101_038,
         B18102_004, B18102_007, B18102_010, B18102_013, B18102_016, B18102_019, B18102_023, B18102_026, B18102_029, B18102_032, B18102_035, B18102_038,
         B18103_004, B18103_007, B18103_010, B18103_013, B18103_016, B18103_019, B18103_023, B18103_026, B18103_029, B18103_032, B18103_035, B18103_038,
         B18104_004, B18104_007, B18104_010, B18104_013, B18104_016, B18104_020, B18104_023, B18104_026, B18104_029, B18104_032,
         B18105_004, B18105_007, B18105_010, B18105_013, B18105_016, B18105_020, B18105_023, B18105_026, B18105_029, B18105_032,
         B18106_004, B18106_007, B18106_010, B18106_013, B18106_016, B18106_020, B18106_023, B18106_026, B18106_029, B18106_032,
         B18107_004, B18107_007, B18107_010, B18107_013, B18107_017, B18107_020, B18107_023, B18107_026,
         ) |>
  mutate(disability = rowSums(across(starts_with("B18101"))),
         hearing_difficulty = rowSums(across(starts_with("B18102"))),
         vision_difficulty = rowSums(across(starts_with("B18103"))),
         cognitive_difficulty = rowSums(across(starts_with("B18104"))),
         ambulatory_difficulty = rowSums(across(starts_with("B18105"))),
         self_care_difficulty = rowSums(across(starts_with("B18106"))),
         independent_living_difficulty = rowSums(across(starts_with("B18107"))),
         ) |>
  select(ends_with(c("_difficulty"))) |>
  summarise(across(everything(), sum, na.rm = TRUE)) |>
  gather(key = "Disability", value = "Count")




 disability_plot <- ggplot(disability_counts, aes(x = Disability, y = Count, fill = Disability)) +
  geom_col() +
  geom_text(
      aes(label = scales::comma(Count)),
      position = position_dodge(width = 0.8),
      vjust = -.5,
      color = "black",
      size = 8,
      size.unit = "pt") +
    scale_fill_manual(values = c("#00447C", "#A7C539", "#F2B705", "#780032", "#e66a8c","#D9D9D9"), ) +
    scale_x_discrete(labels = c("Ambulatory", "Cognitive", "Hearing", "Independent Living", "Self Care", "Vision")) +
    scale_y_continuous(label = scales::comma) +
    theme_urbn_print() +
    labs(x = "", y = "") +
    theme(
      legend.position = "none",
      panel.grid.major.x = element_blank(),
      text = element_text(family = "Arial", color = "black"))
 
disability_plot

ggsave(filename = "disability_counts.png", 
       plot = disability_plot, 
       path = file.path(file_path, boulevard, "Outputs"),
       height = 3.2,
       width = 6.84,
       dpi = 1000)


```



